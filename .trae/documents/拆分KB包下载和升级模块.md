# 拆分KB包下载和升级模块计划

## 1. 拆分方案

### 1.1 创建下载KB包模块
- **方法名**：`download_kb_packages`
- **功能**：负责从KB下载页面获取KB包和KB SIGN文件
- **参数**：
  - `kb_number`：KB编号
  - `target_id`：目标ID
  - `download_path`：下载路径
- **返回值**：
  - 元组 `(success, kb_sign_file, kb_file_path, kb_file_name)`
  - `success`：下载是否成功
  - `kb_sign_file`：KB SIGN文件路径
  - `kb_file_path`：非sign KB包路径
  - `kb_file_name`：非sign KB包名称

### 1.2 创建升级KB包模块
- **方法名**：`update_kb_packages`
- **功能**：负责将下载的KB SIGN文件上传到设备并执行升级操作
- **参数**：
  - `vm_name`：虚拟机名称
  - `network_config`：网络配置
  - `kb_sign_file`：KB SIGN文件路径
  - `login_username`：登录用户名
  - `login_password`：登录密码
- **返回值**：
  - `bool`：升级是否成功

### 1.3 修改原方法
- **保留**：`upgrade_kb_packages` 方法作为调用下载和升级模块的组合方法
- **功能**：按顺序调用下载和升级模块，并启动kb_scan线程

## 2. 模块间依赖分析

### 2.1 直接依赖
- **下载模块 → 升级模块**：下载模块的输出（KB SIGN文件路径）是升级模块的输入
- **升级模块 → 下载模块**：无直接依赖

### 2.2 共同依赖
- **配置依赖**：两个模块都需要KB测试配置（kb_number和target_id）
- **网络依赖**：两个模块都需要网络连接
- **Playwright依赖**：两个模块都使用Playwright进行浏览器操作

### 2.3 依赖处理
- **配置获取**：在`upgrade_kb_packages`方法中统一获取KB测试配置，然后传递给两个模块
- **路径管理**：下载模块负责创建和管理下载路径，确保文件正确保存
- **错误处理**：每个模块独立处理错误，确保一个模块失败不会影响另一个模块的执行

## 3. 更新工作流

### 3.1 修改 `run_workflow` 方法
- **调用方式**：保持原有调用方式不变，仍调用`upgrade_kb_packages`方法
- **内部流程**：`upgrade_kb_packages`方法内部按顺序调用下载和升级模块

### 3.2 错误处理
- **下载失败**：如果下载模块失败，升级模块将不会执行
- **升级失败**：如果升级模块失败，将返回失败状态，工作流将停止

## 4. 实现步骤

1. **创建 `download_kb_packages` 方法**：
   - 提取当前`upgrade_kb_packages`方法中的下载部分
   - 优化参数传递和错误处理

2. **创建 `update_kb_packages` 方法**：
   - 提取当前`upgrade_kb_packages`方法中的升级部分
   - 优化参数传递和错误处理

3. **修改 `upgrade_kb_packages` 方法**：
   - 按顺序调用下载和升级模块
   - 处理模块间的依赖关系
   - 保持原有的返回值格式

4. **测试**：
   - 测试下载模块单独执行
   - 测试升级模块单独执行
   - 测试完整工作流执行

## 5. 优势

- **模块化**：将功能拆分为独立模块，提高代码可维护性
- **可测试性**：每个模块可以单独测试，便于问题定位
- **灵活性**：可以根据需要单独使用下载或升级模块
- **可扩展性**：便于后续添加新的功能或修改现有功能