# 全流程虚拟机管理与KB升级脚本设计

## 功能概述
设计一个完整的Python脚本，实现从查找虚拟机快照到升级KB包的全流程自动化，包括：
1. 查找指定虚拟机的可用快照
2. 恢复虚拟机到指定快照
3. 修改虚拟机IP地址
4. 恢复客户配置（使用配置文件）
5. 升级历史KB包（如果配置中存在）
6. 升级本次KB包

## 技术方案

### 1. 脚本结构
- 创建 `vm_management_workflow.py` 作为主脚本
- 导入并调用现有的功能模块
- 实现新的功能模块来补全缺失的功能

### 2. 核心功能模块

#### 2.1 配置管理
- 创建 `config.json` 配置文件，存储所有配置信息
- 支持通过关键词筛选获取配置
- 新增 `load_config()` 函数，加载配置文件
- 新增 `validate_config()` 函数，验证配置完整性
- 配置文件结构：
  ```json
  {
    "hci_device": {
      "ip": "10.156.1.50",
      "username": "admin",
      "password": "Msgt@202601",
      "http_port": "443"
    },
    "virtual_machines": [
      {
        "name": "XMG5100_不要关_2.127_0001",
        "snapshots": [
          {
            "name": "snapshot_1",
            "description": "快照1"
          }
        ],
        "network_config": {
          "ip_address": "10.156.2.127",
          "subnet_mask": "255.253.0.0",
          "default_gateway": "10.157.255.254"
        }
      }
    ],
    "kb_packages": {
      "historical": ["KB12345", "KB67890"],
      "current": "KB202601"
    },
    "customer_configs": {
      "default": "D:\\配置\\2026_01_14_105715.bcf"
    }
  }
  ```

#### 2.2 虚拟机快照管理
- 基于 `vm_recover.py` 中的功能
- 新增 `get_vm_snapshots()` 函数，获取指定虚拟机的所有快照
- 新增 `select_snapshot()` 函数，根据配置文件中的信息选择合适的快照

#### 2.3 虚拟机IP修改
- 基于 `vm.py` 中的功能
- 新增 `modify_vm_ip()` 函数，根据配置文件修改虚拟机IP地址

#### 2.4 客户配置恢复
- 基于 `peizhi.py` 中的功能
- 新增 `restore_customer_config()` 函数，从配置文件中获取客户配置文件路径并恢复配置

#### 2.5 KB包管理
- 基于 `KB.py` 中的功能
- 新增 `upgrade_historical_kb()` 函数，升级历史KB包（仅当配置中存在历史KB包时执行）
- 新增 `upgrade_current_kb()` 函数，升级本次KB包

#### 2.6 全流程控制
- 新增 `run_workflow()` 函数，协调整个流程的执行
- 实现错误处理和日志记录
- 支持通过关键词从配置文件中筛选配置
- 增加配置完整性检查，确保必要的配置项已填写完整

### 3. 执行流程
1. 加载配置文件
2. 验证配置完整性
3. 根据关键词筛选配置
4. 连接HCI设备
5. 查找指定虚拟机
6. 获取虚拟机快照列表
7. 选择并恢复到指定快照
8. 修改虚拟机IP地址
9. 恢复客户配置
10. 检查配置中是否存在历史KB包，如果存在则升级
11. 升级本次KB包
12. 验证升级结果
13. 输出执行报告

### 4. 依赖项
- 现有依赖：playwright, rsa, requests
- 新增依赖：json, argparse (标准库)

### 5. 输入参数
- 命令行参数：
  - `--config`：配置文件路径（可选，默认：config.json）
  - `--keyword`：配置筛选关键词（可选，默认：使用默认配置）

### 6. 配置验证规则
- 必须填写的配置项：
  - HCI设备登录信息（ip, username, password）
  - 虚拟机信息（name）
  - 网络配置信息（ip_address, default_gateway）
  - 客户配置信息（default）
  - 本次KB包信息（current）
- 可选配置项：
  - 历史KB包信息（historical）
  - 快照信息（snapshots）

### 7. 错误处理
- 配置不完整时，提示用户填写完整的配置
- 执行过程中出错时，记录错误信息并尝试继续执行其他步骤
- 提供详细的错误日志，便于排查问题

## 实现步骤
1. 创建配置文件 `config.json`
2. 创建主脚本 `vm_management_workflow.py`
3. 实现配置管理模块（加载和验证配置）
4. 实现核心功能模块
5. 实现全流程控制逻辑
6. 添加错误处理和日志记录
7. 测试脚本执行流程
8. 优化和调试