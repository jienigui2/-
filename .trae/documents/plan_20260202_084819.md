# 上一次运行截图展示功能实现计划

## 1. 核心功能修改

### 1.1 运行时间跟踪
- **运行时间记录**: 在每次运行程序时，记录开始和结束时间
- **时间存储**: 使用全局变量或配置文件存储上一次运行的时间范围
- **时间比较**: 基于文件的创建时间，判断是否属于上一次运行

### 1.2 截图管理
- **截图扫描**: 扫描 `KB_photo` 和 `KB_compare_photo` 文件夹
- **时间过滤**: 只包含上一次运行时间范围内创建的截图
- **截图信息**: 记录截图的文件名、路径、大小、创建时间等信息

### 1.3 Web界面功能
- **截图展示按钮**: 在操作区域添加"截图展示"按钮
- **截图展示模态框**: 点击按钮后弹出模态框，展示上一次运行的截图
- **截图预览**: 支持缩略图预览和全屏查看
- **截图下载**: 支持单个截图下载
- **自动更新**: 流程结束后自动更新截图列表

### 1.4 后端API
- **`/last_run_screenshots`**: 获取上一次运行的截图信息
- **`/screenshot/<filename>`**: 获取单个截图文件
- **`/refresh_last_run_screenshots`**: 刷新上一次运行的截图列表

## 2. 技术实现细节

### 2.1 运行时间管理
```python
# 全局变量存储运行时间
last_run_info = {
    'start_time': None,
    'end_time': None,
    'screenshots': []
}

def update_last_run_time():
    """更新上一次运行的开始时间"""
    global last_run_info
    last_run_info['start_time'] = time.time()
    last_run_info['screenshots'] = []

def finish_last_run():
    """完成上一次运行，记录结束时间并扫描截图"""
    global last_run_info
    last_run_info['end_time'] = time.time()
    last_run_info['screenshots'] = scan_last_run_screenshots()
```

### 2.2 截图扫描逻辑
```python
def scan_last_run_screenshots():
    """扫描上一次运行产生的截图"""
    screenshots = []
    screenshot_dirs = ['KB_photo', 'KB_compare_photo']
    start_time = last_run_info.get('start_time')
    end_time = last_run_info.get('end_time', time.time())
    
    if not start_time:
        return screenshots
    
    for dir_name in screenshot_dirs:
        if os.path.exists(dir_name):
            for filename in os.listdir(dir_name):
                if filename.endswith('.png'):
                    file_path = os.path.join(dir_name, filename)
                    if os.path.isfile(file_path):
                        file_mtime = os.path.getmtime(file_path)
                        # 检查是否在上一次运行时间范围内
                        if start_time <= file_mtime <= end_time:
                            screenshots.append({
                                'filename': filename,
                                'path': file_path,
                                'size': os.path.getsize(file_path),
                                'mtime': file_mtime,
                                'folder': dir_name
                            })
    
    # 按修改时间排序，最新的在前
    screenshots.sort(key=lambda x: x['mtime'], reverse=True)
    return screenshots
```

### 2.3 前端界面
- **模态框设计**: 使用响应式模态框
- **图片预览**: 点击缩略图查看大图
- **时间显示**: 显示截图的创建时间，便于确认是否属于上一次运行

### 2.4 流程集成
- **运行开始**: 调用 `update_last_run_time()` 记录开始时间
- **运行结束**: 调用 `finish_last_run()` 记录结束时间并扫描截图
- **界面更新**: 自动刷新截图列表

## 3. 实现步骤

1. **添加运行时间管理**
   - 实现运行时间记录功能
   - 集成到程序运行流程中

2. **实现截图扫描逻辑**
   - 扫描指定时间范围内的截图
   - 过滤出上一次运行的截图

3. **修改Web界面**
   - 添加截图展示按钮
   - 创建截图展示模态框
   - 实现截图预览功能

4. **添加后端API**
   - 实现截图相关API路由
   - 提供截图访问功能

5. **测试和优化**
   - 测试截图展示功能
   - 验证只显示上一次运行的截图
   - 优化性能和用户体验

## 4. 预期效果

- **用户操作**: 点击"截图展示"按钮，查看上一次运行的截图
- **流程结束**: 自动更新截图列表，展示最新运行的截图
- **时间准确性**: 只包含上一次运行时间范围内的截图
- **用户体验**: 响应式设计，操作流畅

## 5. 技术要点

- **时间管理**: 精确记录和比较时间
- **文件系统操作**: 基于文件修改时间过滤文件
- **Flask静态文件**: 配置静态文件路由，提供截图访问
- **前端JavaScript**: 实现模态框和图片预览功能
- **流程集成**: 无缝集成到现有运行流程中

此实现将确保用户只能看到上一次运行产生的截图，避免混淆，提高用户体验。